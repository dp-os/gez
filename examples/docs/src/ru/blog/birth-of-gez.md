---
titleSuffix: "От проблем микрофронтенда к инновациям ESM: Путь эволюции фреймворка Gez"
description: Глубокое исследование эволюции фреймворка Gez от традиционной архитектуры микрофронтенда к инновационным решениям на основе ESM. Поделимся техническим опытом в оптимизации производительности, управлении зависимостями и выборе инструментов сборки.
head:
  - - meta
    - property: keywords
      content: Gez, микрофронтенд, ESM, Import Maps, Rspack, Module Federation, управление зависимостями, оптимизация производительности, техническая эволюция, серверный рендеринг
sidebar: false
---

# От совместного использования компонентов к нативной модульности: Путь эволюции микрофронтенд фреймворка Gez

## Контекст проекта

В последние годы архитектура микрофронтенда искала правильный путь. Однако мы наблюдали множество сложных технических решений, которые с помощью многослойных оберток и искусственной изоляции пытались имитировать идеальный мир микрофронтенда. Эти решения привносили значительные потери производительности, усложняли разработку и делали стандартные процессы запутанными.

### Ограничения традиционных подходов

В процессе внедрения архитектуры микрофронтенда мы столкнулись с множеством ограничений традиционных решений:

- **Потери производительности**: Внедрение зависимостей в runtime, проксирование JS-песочницы — каждая операция потребляет драгоценные ресурсы.
- **Хрупкая изоляция**: Искусственно созданная среда песочницы никогда не сможет достичь уровня нативной изоляции браузера.
- **Сложность сборки**: Для обработки зависимостей приходится модифицировать инструменты сборки, что делает простые проекты сложными в поддержке.
- **Кастомные правила**: Специальные стратегии развертывания и обработки в runtime отдаляют каждый шаг от стандартных процессов современной разработки.
- **Ограничения экосистемы**: Привязка к фреймворкам, кастомные API вынуждают привязываться к конкретной экосистеме.

Эти проблемы особенно ярко проявились в одном из наших корпоративных проектов в 2019 году. Тогда крупный продукт был разделен на более чем десяток независимых бизнес-подсистем, которым нужно было совместно использовать набор базовых и бизнес-компонентов. Изначально использованное решение на основе npm-пакетов для совместного использования компонентов выявило серьезные проблемы с эффективностью поддержки: при обновлении общего компонента все подсистемы, зависящие от него, должны были пройти полный процесс сборки и развертывания.

## Техническая эволюция

### v1.0: Исследование удаленных компонентов

Для решения проблемы эффективности совместного использования компонентов в Gez v1.0 была введена механизм компонентов RemoteView на основе HTTP-протокола. Это решение позволило динамически запрашивать код во время выполнения, что успешно решило проблему длинных цепочек зависимостей при сборке. Однако из-за отсутствия стандартизированного механизма взаимодействия в runtime, синхронизация состояния и передача событий между сервисами все еще оставались неэффективными.

### v2.0: Эксперименты с Module Federation

В версии v2.0 мы использовали технологию [Module Federation](https://webpack.js.org/concepts/module-federation/) из [Webpack 5.0](https://webpack.js.org/). Эта технология, благодаря унифицированному механизму загрузки модулей и контейнеру в runtime, значительно повысила эффективность взаимодействия между сервисами. Однако при масштабном использовании закрытая реализация Module Federation привела к новым вызовам: стало сложно управлять точными версиями зависимостей, особенно при унификации общих зависимостей между несколькими сервисами, что часто приводило к конфликтам версий и ошибкам в runtime.

## Вступление в новую эру ESM

При планировании версии v3.0 мы глубоко изучили тенденции развития фронтенд-экосистемы и обнаружили, что прогресс в нативных возможностях браузеров открывает новые перспективы для архитектуры микрофронтенда:

### Стандартизированная модульная система

С повсеместной поддержкой [ES Modules](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules) в основных браузерах и зрелостью спецификации [Import Maps](https://github.com/WICG/import-maps), фронтенд-разработка вступила в эпоху настоящей модульности. Согласно данным [Can I Use](https://caniuse.com/?search=importmap), поддержка ESM в основных браузерах (Chrome >= 89, Edge >= 89, Firefox >= 108, Safari >= 16.4) достигла 93.5%, что предоставляет нам следующие преимущества:

- **Стандартизация управления зависимостями**: Import Maps предоставляет возможность разрешения зависимостей модулей на уровне браузера, без необходимости сложного внедрения в runtime.
- **Оптимизация загрузки ресурсов**: Нативный механизм кэширования модулей в браузере значительно повышает эффективность загрузки ресурсов.
- **Упрощение процесса сборки**: Разработка на основе ESM делает процессы сборки в development и production средах более согласованными.

Кроме того, благодаря поддержке режима совместимости (Chrome >= 87, Edge >= 88, Firefox >= 78, Safari >= 14), мы можем увеличить покрытие браузеров до 96.81%, что позволяет нам сохранить высокую производительность, не жертвуя поддержкой старых браузеров.

### Прорыв в производительности и изоляции

Нативная модульная система приносит не только стандартизацию, но и значительное улучшение производительности и изоляции:

- **Нулевые накладные расходы в runtime**: Мы избавились от проксирования JavaScript-песочницы и внедрения зависимостей в runtime, характерных для традиционных решений микрофронтенда.
- **Надежная изоляция**: Строгая область видимости модулей ESM обеспечивает наиболее надежную изоляцию.
- **Точное управление зависимостями**: Статический анализ импорта делает зависимости более прозрачными, а управление версиями — более точным.

### Выбор инструментов сборки

В процессе реализации технического решения выбор инструментов сборки стал ключевым моментом. После почти года исследований и практики наш выбор прошел следующие этапы:

1. **Исследование Vite**
   - Преимущества: Development-сервер на основе ESM, обеспечивающий превосходный опыт разработки.
   - Проблемы: Различия в сборке development и production сред создавали некоторую неопределенность.

2. **Утверждение [Rspack](https://www.rspack.dev/)**
   - Преимущества производительности: Высокоскоростная компиляция на основе [Rust](https://www.rust-lang.org/), значительно ускоряющая процесс сборки.
   - Поддержка экосистемы: Высокая совместимость с экосистемой Webpack снижает затраты на миграцию.
   - Поддержка ESM: Практика проекта Rslib подтвердила надежность Rspack в сборке ESM.

Это решение позволило нам сохранить удобство разработки, обеспечив при этом более стабильную поддержку production среды. Комбинация ESM и Rspack в итоге позволила создать высокопроизводительное и минимально инвазивное решение для микрофронтенда.

## Перспективы развития

В планах развития фреймворка Gez мы сосредоточимся на следующих трех направлениях:

### Глубокая оптимизация Import Maps

- **Динамическое управление зависимостями**: Реализация интеллектуального управления версиями зависимостей в runtime для решения конфликтов между приложениями.
- **Стратегии предзагрузки**: Интеллектуальная предзагрузка на основе анализа маршрутов для повышения эффективности загрузки ресурсов.
- **Оптимизация сборки**: Автоматическая генерация оптимальных конфигураций Import Maps для уменьшения ручной настройки разработчиками.

### Независимая от фреймворков маршрутизация

- **Унифицированная абстракция маршрутизации**: Разработка интерфейса маршрутизации, независимого от фреймворков, с поддержкой Vue, React и других популярных фреймворков.
- **Маршрутизация микро-приложений**: Реализация взаимодействия маршрутов между приложениями для поддержания согласованности URL и состояния приложения.
- **Промежуточное ПО для маршрутизации**: Предоставление расширяемого механизма middleware для управления доступом, переходами между страницами и других функций.

### Лучшие практики межфреймворкового взаимодействия

- **Примеры приложений**: Предоставление полных примеров межфреймворкового взаимодействия, охватывающих Vue, React, Preact и другие популярные фреймворки.
- **Синхронизация состояния**: Легковесное решение для совместного использования состояния на основе ESM.
- **Шина событий**: Стандартизированный механизм передачи событий для обеспечения слабосвязанного взаимодействия между приложениями.

С помощью этих оптимизаций и расширений мы стремимся сделать Gez более совершенным и удобным решением для микрофронтенда, предоставляя разработчикам лучший опыт и более высокую эффективность разработки.