---
titleSuffix: Механизм совместного использования кода между сервисами в Gez
description: Подробное описание механизма связывания модулей в Gez, включая совместное использование кода между сервисами, управление зависимостями и реализацию спецификации ESM, чтобы помочь разработчикам создавать эффективные микросервисные приложения.
head:
  - - meta
    - property: keywords
      content: Gez, связывание модулей, Module Link, ESM, совместное использование кода, управление зависимостями, микросервисы
---

# Связывание модулей

Gez предоставляет полный механизм связывания модулей для управления совместным использованием кода и зависимостями между сервисами. Этот механизм реализован на основе спецификации ESM (ECMAScript Module) и поддерживает экспорт и импорт модулей на уровне исходного кода, а также полное управление зависимостями.

### Основные концепции

#### Экспорт модулей
Экспорт модулей — это процесс предоставления доступа к определенным единицам кода (например, компонентам, утилитам и т.д.) из сервиса в формате ESM. Поддерживаются два типа экспорта:
- **Экспорт исходного кода**: прямой экспорт файлов исходного кода из проекта
- **Экспорт зависимостей**: экспорт сторонних пакетов, используемых в проекте

#### Импорт модулей
Импорт модулей — это процесс использования единиц кода, экспортированных другими сервисами. Поддерживаются несколько способов установки:
- **Установка исходного кода**: подходит для среды разработки, поддерживает изменения в реальном времени и горячую перезагрузку
- **Установка пакетов**: подходит для производственной среды, использует готовые сборки

### Механизм предварительной загрузки

Для оптимизации производительности сервисов Gez реализует интеллектуальный механизм предварительной загрузки модулей:

1. **Анализ зависимостей**
   - Анализ зависимостей между компонентами во время сборки
   - Идентификация ключевых модулей на критическом пути
   - Определение приоритета загрузки модулей

2. **Стратегия загрузки**
   - **Немедленная загрузка**: ключевые модули на критическом пути
   - **Отложенная загрузка**: модули не критичных функций
   - **Загрузка по требованию**: модули, отображаемые по условию

3. **Оптимизация ресурсов**
   - Интеллектуальная стратегия разделения кода
   - Управление кэшированием на уровне модулей
   - Компиляция и сборка по требованию

## Экспорт модулей

### Настройка

Настройка экспортируемых модулей в `entry.node.ts`:

```ts title="src/entry.node.ts"
import type { GezOptions } from '@gez/core';

export default {
    modules: {
        exports: [
            // Экспорт файлов исходного кода
            'root:src/components/button.vue',  // Компонент Vue
            'root:src/utils/format.ts',        // Утилита
            // Экспорт сторонних зависимостей
            'npm:vue',                         // Фреймворк Vue
            'npm:vue-router'                   // Vue Router
        ]
    }
} satisfies GezOptions;
```

Поддерживаются два типа экспорта:
- `root:*`: экспорт файлов исходного кода, путь относительно корня проекта
- `npm:*`: экспорт сторонних зависимостей, указывается имя пакета

## Импорт модулей

### Настройка

Настройка импортируемых модулей в `entry.node.ts`:

```ts title="src/entry.node.ts"
import type { GezOptions } from '@gez/core';

export default {
    modules: {
        // Настройка импорта
        imports: {
            // Установка исходного кода: указывает на директорию сборки
            'ssr-remote': 'root:./node_modules/ssr-remote/dist',
            // Установка пакетов: указывает на директорию пакета
            'other-remote': 'root:./node_modules/other-remote'
        },
        // Настройка внешних зависимостей
        externals: {
            // Использование зависимостей из удаленного модуля
            'vue': 'ssr-remote/npm/vue',
            'vue-router': 'ssr-remote/npm/vue-router'
        }
    }
} satisfies GezOptions;
```

Описание настроек:
1. **imports**: настройка локального пути к удаленным модулям
   - Установка исходного кода: указывает на директорию сборки (dist)
   - Установка пакетов: указывает на директорию пакета

2. **externals**: настройка внешних зависимостей
   - Для совместного использования зависимостей из удаленных модулей
   - Избежание дублирования зависимостей
   - Поддержка совместного использования зависимостей между несколькими модулями

### Способы установки

#### Установка исходного кода
Подходит для среды разработки, поддерживает изменения в реальном времени и горячую перезагрузку.

1. **Workspace**
Рекомендуется для использования в Monorepo:
```ts title="package.json"
{
    "devDependencies": {
        "ssr-remote": "workspace:*"
    }
}
```

2. **Link**
Для локальной разработки и отладки:
```ts title="package.json"
{
    "devDependencies": {
        "ssr-remote": "link:../ssr-remote"
    }
}
```

#### Установка пакетов
Подходит для производственной среды, использует готовые сборки.

1. **NPM Registry**
Установка через npm registry:
```ts title="package.json"
{
    "dependencies": {
        "ssr-remote": "^1.0.0"
    }
}
```

2. **Статический сервер**
Установка через HTTP/HTTPS:
```ts title="package.json"
{
    "dependencies": {
        "ssr-remote": "https://cdn.example.com/ssr-remote/1.0.0.tgz"
    }
}
```

## Сборка пакетов

### Настройка

Настройка параметров сборки в `entry.node.ts`:

```ts title="src/entry.node.ts"
import type { GezOptions } from '@gez/core';

export default {
    // Настройка экспорта модулей
    modules: {
        exports: [
            'root:src/components/button.vue',
            'root:src/utils/format.ts',
            'npm:vue'
        ]
    },
    // Настройка сборки
    pack: {
        // Включение сборки
        enable: true,

        // Настройка выходных данных
        outputs: [
            'dist/client/versions/latest.tgz',
            'dist/client/versions/1.0.0.tgz'
        ],

        // Настройка package.json
        packageJson: async (gez, pkg) => {
            pkg.version = '1.0.0';
            return pkg;
        },

        // Действия перед сборкой
        onBefore: async (gez, pkg) => {
            // Генерация типов
            // Запуск тестов
            // Обновление документации и т.д.
        },

        // Действия после сборки
        onAfter: async (gez, pkg, file) => {
            // Загрузка на CDN
            // Публикация в npm
            // Развертывание в тестовой среде и т.д.
        }
    }
} satisfies GezOptions;
```

### Результаты сборки

```
your-app-name.tgz
├── package.json        # Информация о пакете
├── index.js            # Входная точка для production
├── server/             # Ресурсы для сервера
│   └── manifest.json   # Карта ресурсов сервера
├── node/               # Среда выполнения Node.js
└── client/             # Ресурсы для клиента
    └── manifest.json   # Карта ресурсов клиента
```

### Процесс публикации

```bash
# 1. Сборка production версии
gez build

# 2. Публикация в npm
npm publish dist/versions/your-app-name.tgz
```

## Лучшие практики

### Настройка среды разработки
- **Управление зависимостями**
  - Использование Workspace или Link для установки зависимостей
  - Унификация версий зависимостей
  - Избежание дублирования зависимостей

- **Опыт разработки**
  - Включение горячей перезагрузки
  - Настройка подходящей стратегии предварительной загрузки
  - Оптимизация скорости сборки

### Настройка производственной среды
- **Стратегия развертывания**
  - Использование NPM Registry или статического сервера
  - Обеспечение целостности сборки
  - Внедрение механизма постепенного развертывания

- **Оптимизация производительности**
  - Настройка предварительной загрузки ресурсов
  - Оптимизация порядка загрузки модулей
  - Внедрение эффективной стратегии кэширования

### Управление версиями
- **Стандарты версий**
  - Следование семантическому версионированию
  - Ведение подробного журнала изменений
  - Проведение тестов на совместимость версий

- **Обновление зависимостей**
  - Своевременное обновление зависимостей
  - Регулярный аудит безопасности
  - Поддержание согласованности версий зависимостей
```