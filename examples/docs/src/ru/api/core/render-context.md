---
titleSuffix: Справочник API контекста рендеринга Gez
description: Подробное описание основного класса RenderContext в фреймворке Gez, включая управление рендерингом, управление ресурсами, синхронизацию состояния и управление маршрутизацией, чтобы помочь разработчикам реализовать эффективный серверный рендеринг.
head:
  - - meta
    - property: keywords
      content: Gez, RenderContext, SSR, серверный рендеринг, контекст рендеринга, синхронизация состояния, управление ресурсами, фреймворк для веб-приложений
---

# RenderContext

RenderContext — это основной класс в фреймворке Gez, отвечающий за управление полным жизненным циклом серверного рендеринга (SSR). Он предоставляет полный набор API для обработки контекста рендеринга, управления ресурсами, синхронизации состояния и других ключевых задач:

- **Управление рендерингом**: Управление процессом серверного рендеринга, поддержка многопоточного рендеринга, условного рендеринга и других сценариев.
- **Управление ресурсами**: Интеллектуальный сбор и внедрение статических ресурсов, таких как JS, CSS, для оптимизации производительности загрузки.
- **Синхронизация состояния**: Обработка сериализации состояния на сервере, обеспечение правильной гидратации на клиенте.
- **Управление маршрутизацией**: Поддержка серверных перенаправлений, установка кодов состояния и других расширенных функций.

## Определения типов

### ServerRenderHandle

Определение типа функции обработки серверного рендеринга.

```ts
type ServerRenderHandle = (rc: RenderContext) => Promise<void> | void;
```

Функция обработки серверного рендеринга — это асинхронная или синхронная функция, которая принимает экземпляр RenderContext в качестве параметра и используется для обработки логики серверного рендеринга.

```ts title="entry.node.ts"
// 1. Асинхронная функция
export default async (rc: RenderContext) => {
  const app = createApp();
  const html = await renderToString(app);
  rc.html = html;
};

// 2. Синхронная функция
export const simple = (rc: RenderContext) => {
  rc.html = '<h1>Hello World</h1>';
};
```

### RenderFiles

Определение типа списка файлов ресурсов, собранных в процессе рендеринга.

```ts
interface RenderFiles {
  js: string[];
  css: string[];
  modulepreload: string[];
  resources: string[];
}
```

- **js**: Список файлов JavaScript
- **css**: Список файлов стилей
- **modulepreload**: Список модулей ESM, которые необходимо предварительно загрузить
- **resources**: Список других ресурсов (изображения, шрифты и т.д.)

```ts
// Пример списка файлов ресурсов
rc.files = {
  js: [
    '/assets/entry-client.js',
    '/assets/vendor.js'
  ],
  css: [
    '/assets/main.css',
    '/assets/vendor.css'
  ],
  modulepreload: [
    '/assets/Home.js',
    '/assets/About.js'
  ],
  resources: [
    '/assets/logo.png',
    '/assets/font.woff2'
  ]
};
```

### ImportmapMode

Определение режима генерации importmap.

```ts
type ImportmapMode = 'inline' | 'js';
```

- `inline`: Встраивание содержимого importmap непосредственно в HTML, подходит для следующих сценариев:
  - Необходимо уменьшить количество HTTP-запросов
  - Содержимое importmap небольшое
  - Требуется высокая производительность при загрузке первой страницы
- `js`: Генерация содержимого importmap в виде отдельного JS-файла, подходит для следующих сценариев:
  - Содержимое importmap большое
  - Необходимо использовать механизм кэширования браузера
  - Несколько страниц используют один и тот же importmap

Класс контекста рендеринга, отвечающий за управление ресурсами и генерацию HTML в процессе серверного рендеринга (SSR).
## Параметры экземпляра

Определение параметров конфигурации контекста рендеринга.

```ts
interface RenderContextOptions {
  base?: string
  entryName?: string
  params?: Record<string, any>
  importmapMode?: ImportmapMode
}
```

#### base

- **Тип**: `string`
- **Значение по умолчанию**: `''`

Базовый путь для статических ресурсов.
- Все статические ресурсы (JS, CSS, изображения и т.д.) загружаются относительно этого пути
- Поддерживает динамическую конфигурацию во время выполнения, без необходимости пересборки
- Часто используется в многоязычных сайтах, микросервисных приложениях и других сценариях

#### entryName

- **Тип**: `string`
- **Значение по умолчанию**: `'default'`

Имя функции входа для серверного рендеринга. Используется для указания функции входа, которая будет использоваться при серверном рендеринге, когда модуль экспортирует несколько функций рендеринга.

```ts title="src/entry.server.ts"
export const mobile = async (rc: RenderContext) => {
  // Логика рендеринга для мобильных устройств
};

export const desktop = async (rc: RenderContext) => {
  // Логика рендеринга для настольных устройств
};
```

#### params

- **Тип**: `Record<string, any>`
- **Значение по умолчанию**: `{}`

Параметры рендеринга. Можно передавать параметры любого типа в функцию рендеринга, часто используется для передачи информации о запросе (URL, параметры запроса и т.д.).

```ts
const rc = await gez.render({
  params: {
    url: req.url,
    lang: 'zh-CN',
    theme: 'dark'
  }
});
```

#### importmapMode

- **Тип**: `'inline' | 'js'`
- **Значение по умолчанию**: `'inline'`

Режим генерации карты импорта (Import Map):
- `inline`: Встраивание содержимого importmap непосредственно в HTML
- `js`: Генерация содержимого importmap в виде отдельного JS-файла


## Свойства экземпляра

### gez

- **Тип**: `Gez`
- **Только для чтения**: `true`

Ссылка на экземпляр Gez. Используется для доступа к основным функциям и конфигурациям фреймворка.

### redirect

- **Тип**: `string | null`
- **Значение по умолчанию**: `null`

Адрес перенаправления. После установки сервер может выполнить HTTP-перенаправление на основе этого значения, часто используется для проверки авторизации, управления доступом и других сценариев.

```ts title="entry.node.ts"
// Пример проверки авторизации
export default async (rc: RenderContext) => {
  if (!isLoggedIn()) {
    rc.redirect = '/login';
    rc.status = 302;
    return;
  }
  // Продолжение рендеринга страницы...
};

// Пример управления доступом
export default async (rc: RenderContext) => {
  if (!hasPermission()) {
    rc.redirect = '/403';
    rc.status = 403;
    return;
  }
  // Продолжение рендеринга страницы...
};
```

### status

- **Тип**: `number | null`
- **Значение по умолчанию**: `null`

Код состояния HTTP. Можно установить любой допустимый код состояния HTTP, часто используется для обработки ошибок, перенаправлений и других сценариев.

```ts title="entry.node.ts"
// Пример обработки ошибки 404
export default async (rc: RenderContext) => {
  const page = await findPage(rc.params.url);
  if (!page) {
    rc.status = 404;
    // Рендеринг страницы 404...
    return;
  }
  // Продолжение рендеринга страницы...
};

// Пример временного перенаправления
export default async (rc: RenderContext) => {
  if (needMaintenance()) {
    rc.redirect = '/maintenance';
    rc.status = 307; // Временное перенаправление, метод запроса остается неизменным
    return;
  }
  // Продолжение рендеринга страницы...
};
```

### html

- **Тип**: `string`
- **Значение по умолчанию**: `''`

Содержимое HTML. Используется для установки и получения окончательного сгенерированного HTML-содержимого, при установке автоматически обрабатываются заполнители базового пути.

```ts title="entry.node.ts"
// Базовое использование
export default async (rc: RenderContext) => {
  // Установка содержимого HTML
  rc.html = `
    <!DOCTYPE html>
    <html>
      <head>
        ${rc.preload()}
        ${rc.css()}
      </head>
      <body>
        <div id="app">Hello World</div>
        ${rc.importmap()}
        ${rc.moduleEntry()}
        ${rc.modulePreload()}
      </body>
    </html>
  `;
};

// Динамический базовый путь
const rc = await gez.render({
  base: '/app',  // Установка базового пути
  params: { url: req.url }
});

// Заполнители в HTML будут автоматически заменены:
// [[[___GEZ_DYNAMIC_BASE___]]]/your-app-name/css/style.css
// Заменяется на:
// /app/your-app-name/css/style.css
```

### base

- **Тип**: `string`
- **Только для чтения**: `true`
- **Значение по умолчанию**: `''`

Базовый путь для статических ресурсов. Все статические ресурсы (JS, CSS, изображения и т.д.) загружаются относительно этого пути, поддерживает динамическую конфигурацию во время выполнения.

```ts
// Базовое использование
const rc = await gez.render({
  base: '/gez',  // Установка базового пути
  params: { url: req.url }
});

// Пример многоязычного сайта
const rc = await gez.render({
  base: '/cn',  // Китайский сайт
  params: { lang: 'zh-CN' }
});

// Пример микросервисного приложения
const rc = await gez.render({
  base: '/app1',  // Подприложение 1
  params: { appId: 1 }
});
```

### entryName

- **Тип**: `string`
- **Только для чтения**: `true`
- **Значение по умолчанию**: `'default'`

Имя функции входа для серверного рендеринга. Используется для выбора функции рендеринга из entry.server.ts.

```ts title="entry.node.ts"
// Функция входа по умолчанию
export default async (rc: RenderContext) => {
  // Логика рендеринга по умолчанию
};

// Несколько функций входа
export const mobile = async (rc: RenderContext) => {
  // Логика рендеринга для мобильных устройств
};

export const desktop = async (rc: RenderContext) => {
  // Логика рендеринга для настольных устройств
};

// Выбор функции входа в зависимости от типа устройства
const rc = await gez.render({
  entryName: isMobile ? 'mobile' : 'desktop',
  params: { url: req.url }
});
```

### params

- **Тип**: `Record<string, any>`
- **Только для чтения**: `true`
- **Значение по умолчанию**: `{}`

Параметры рендеринга. Можно передавать и получать параметры в процессе серверного рендеринга, часто используется для передачи информации о запросе, конфигурации страницы и т.д.

```ts
// Базовое использование - передача URL и настроек языка
const rc = await gez.render({
  params: {
    url: req.url,
    lang: 'zh-CN'
  }
});

// Конфигурация страницы - установка темы и макета
const rc = await gez.render({
  params: {
    theme: 'dark',
    layout: 'sidebar'
  }
});

// Конфигурация окружения - внедрение адреса API
const rc = await gez.render({
  params: {
    apiBaseUrl: process.env.API_BASE_URL,
    version: '1.0.0'
  }
});
```

### importMetaSet

- **Тип**: `Set<ImportMeta>`

Коллекция зависимостей модулей. Автоматически отслеживает и записывает зависимости модулей в процессе рендеринга компонентов, собирает только те ресурсы, которые действительно используются при рендеринге текущей страницы.

```ts
// Базовое использование
const renderToString = (app: any, context: { importMetaSet: Set<ImportMeta> }) => {
  // Автоматический сбор зависимостей модулей в процессе рендеринга
  // Фреймворк автоматически вызывает context.importMetaSet.add(import.meta) при рендеринге компонентов
  // Разработчикам не нужно вручную обрабатывать сбор зависимостей
  return '<div id="app">Hello World</div>';
};

// Пример использования
const app = createApp();
const html = await renderToString(app, {
  importMetaSet: rc.importMetaSet
});
```

### files

- **Тип**: `RenderFiles`

Список файлов ресурсов:
- js: Список файлов JavaScript
- css: Список файлов стилей
- modulepreload: Список модулей ESM, которые необходимо предварительно загрузить
- resources: Список других ресурсов (изображения, шрифты и т.д.)

```ts
// Сбор ресурсов
await rc.commit();

// Внедрение ресурсов
rc.html = `
  <!DOCTYPE html>
  <html>
  <head>
    <!-- Предварительная загрузка ресурсов -->
    ${rc.preload()}
    <!-- Внедрение стилей -->
    ${rc.css()}
  </head>
  <body>
    ${html}
    ${rc.importmap()}
    ${rc.moduleEntry()}
    ${rc.modulePreload()}
  </body>
  </html>
`;
```

### importmapMode

- **Тип**: `'inline' | 'js'`
- **Значение по умолчанию**: `'inline'`

Режим генерации карты импорта:
- `inline`: Встраивание содержимого importmap непосредственно в HTML
- `js`: Генерация содержимого importmap в виде отдельного JS-файла


## Методы экземпляра

### serialize()

- **Параметры**: 
  - `input: any` - Данные для сериализации
  - `options?: serialize.SerializeJSOptions` - Параметры сериализации
- **Возвращаемое значение**: `string`

Сериализация объекта JavaScript в строку. Используется для сериализации данных состояния в процессе серверного рендеринга, чтобы данные можно было безопасно встроить в HTML.

```ts
const state = {
  user: { id: 1, name: 'Alice' },
  timestamp: new Date()
};

rc.html = `
  <script>
    window.__INITIAL_STATE__ = ${rc.serialize(state)};
  </script>
`;
```

### state()

- **Параметры**: 
  - `varName: string` - Имя переменной
  - `data: Record<string, any>` - Данные состояния
- **Возвращаемое значение**: `string`

Сериализация данных состояния и их внедрение в HTML. Использует безопасные методы сериализации для обработки данных, поддерживает сложные структуры данных.

```ts
const userInfo = {
  id: 1,
  name: 'John',
  roles: ['admin']
};

rc.html = `
  <head>
    ${rc.state('__USER__', userInfo)}
  </head>
`;
```

### commit()

- **Возвращаемое значение**: `Promise<void>`

Фиксация сбора зависимостей и обновление списка ресурсов. Собирает все используемые модули из importMetaSet, анализирует конкретные ресурсы каждого модуля на основе manifest-файла.

```ts
// Рендеринг и фиксация зависимостей
const html = await renderToString(app, {
  importMetaSet: rc.importMetaSet
});

// Фиксация сбора зависимостей
await rc.commit();
```

### preload()

- **Возвращаемое значение**: `string`

Генерация тегов предварительной загрузки ресурсов. Используется для предварительной загрузки ресурсов CSS и JavaScript, поддерживает настройку приоритетов, автоматически обрабатывает базовый путь.

```ts
rc.html = `
  <!DOCTYPE html>
  <html>
  <head>
    ${rc.preload()}
    ${rc.css()}  <!-- Внедрение стилей -->
  </head>
  <body