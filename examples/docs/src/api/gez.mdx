import { Badge } from '@theme';

# Gez

## GezOptions
使用方式：
```ts title="src/entry.node.ts"
import type { GezOptions } from '@gez/core';

export default {
    // 配置选项
} satisfies GezOptions;

```

### name <Badge text="v3.0.0" type="tip" />
- **类型：** `string`
- **默认值：** `'gez'`
- **描述：** 服务的名称，全局唯一。

:::tip
如果你的网站，同一个域名下，使用 Gez 打包了多个项目，那么你需要配置一个 `name` 来区分不同的项目。
:::

### root <Badge text="v3.0.0" type="tip" />
- **类型：** `string`
- **默认值：** `cwd()`
- **描述：** 项目根目录，默认为当前执行命令的目录。

:::warning
如果你没有充足的理由，你都不应该配置它。
:::

### isProd <Badge text="v3.0.0" type="tip" />
- **类型：** `boolean`
- **默认值：** `process.env.NODE_ENV === 'production'`
- **描述：** 是否是生产环境。

:::warning
如果你没有充足的理由，你都不应该配置它。
:::

### isInstall <Badge text="v3.0.0" type="tip" />
- **类型：** `boolean`
- **默认值：** `process.env.npm_config_production !== 'true'`
- **描述：** 安装生产依赖时，是否安装远程依赖。

:::warning
如果你没有充足的理由，你都不应该配置它。
:::

### basePathPlaceholder <Badge text="v3.0.0" type="tip" />
- **类型：** `string | false`
- **默认值：** `'[[[___GEZ_DYNAMIC_BASE___]]]'`
- **描述：** 动态路径的变量占位符，深入了解请看[基本路径](/guide/essentials/base-path.mdx)说明。

::: tip
如果你的业务不存在动态路径的需求，可以设置 `false`，减少一次占位符替换，来提升渲染性能。
:::

### modules
模块链接配置。
#### modules.exports <Badge text="v3.0.0" type="tip" />
- **类型：** `string[]`
- **默认值：** `[]`
- **描述：** 对外模块导出。

```ts title="src/entry.node.ts"
export default {
    modules: {
        exports: [
            'root:src/components/layout.vue',
            'root:src/utils/index.ts',
            'npm:vue',
            'npm:vue-router'
        ]
    }
} satisfies GezOptions;
```

::: tip
你可以将当前项目的模块或者当前项目的第三方依赖，对外导出，这样其它服务就可以使用了。
:::

#### modules.imports <Badge text="v3.0.0" type="tip" />
- **类型：** `Record<string, string | [string, string]>`
- **默认值：** `{}`
- **描述：** 配置远程依赖。
```ts title="src/entry.node.ts"
export default {
    modules: {
        imports: {
            'ssr-base': ['root:../ssr-base/dist', 'https://<hostname>/ssr-base/versions/latest.json']
        }
    }
} satisfies GezOptions;
```

:::tip
- 第一个参数为本地的存储路径
- 第二个参数是远程依赖的地址
- 执行 `gez install` 命令可以下载远程依赖到本地的地址。

:::

你也可以直接配置本地地址。

```ts title="src/entry.node.ts"
export default {
    modules: {
        imports: {
            'ssr-base': 'root:../ssr-base/dist'
        }
    }
} satisfies GezOptions;
```

#### modules.externals <Badge text="v3.0.0" type="tip" />
- **类型：** `Record<string, string>`
- **默认值：** `{}`
- **描述：** 外部依赖设置，你可以将当前服务的依赖，指向到其它导出的服务。
```ts title="src/entry.node.ts"
export default {
    name: 'ssr-main',
    modules: {
        externals: {
            vue: 'ssr-base/npm/vue',
            'vue-router': 'ssr-base/npm/vue-router'
        }
    }
} satisfies GezOptions;
```

:::warning
需要先配置对应服务的 [modules.imports](#modulesimports)，否则运行起来会报错，提示找不到模块。
:::

### createDevApp() <Badge text="v3.0.0" type="tip" />
- **类型：** `(gez: Gez) => Promise<App>`
- **默认值：** `isProd === false`
- **描述：** 创建开发应用，在执行 [dev](/guide/essentials/command.mdx#gez-dev)、[build](/guide/essentials/command.mdx#gez-build)、[preview](/guide/essentials/command.mdx#gez-preview) 命令时调用。

```ts title="src/entry.node.ts"

export default {
    async createDevApp(gez) {
        return import('@gez/rspack').then((m) =>
            m.createRspackHtmlApp(gez, {
                config(context) {
                    // 可以在这里修改 Rspack 编译的配置
                }
            })
        );
    }
} satisfies GezOptions;
```

::: tip
- Rspack 配置请看[这里](./rspack.mdx)

:::

### createServer() <Badge text="v3.0.0" type="tip" />
- **类型：** `(gez: Gez) => Promise<void>`
- **默认值：** `undefined`
- **描述：** 创建服务器，执行  [dev](/guide/essentials/command.mdx#gez-dev)、[build](/guide/essentials/command.mdx#gez-build)、[preview](/guide/essentials/command.mdx#gez-preview) 命令时调用。

```ts title="src/entry.node.ts"
import http from 'node:http';

export default {
    async createServer(gez) {
        const server = http.createServer((req, res) => {
            // 静态文件处理
            gez.middleware(req, res, async () => {
                // 传入渲染的参数
                const render = await gez.render({
                    params: {
                        url: req.url
                    }
                });
                // 响应 HTML 内容
                res.end(render.html);
            });
        });
        // 监听端口
        server.listen(3000, () => {
            console.log('http://localhost:3000');
        });
    },
} satisfies GezOptions;
```
::: tip
你也可以使用其它的框架来创建服务器，例如：[Express](https://expressjs.com/)。
:::

### postCompileProdHook() <Badge text="v3.0.0" type="tip" />
- **类型：** `(gez: Gez) => Promise<void>`
- **默认值：** `undefined`
- **描述：** [gez build](/guide/essentials/command.mdx#gez-build) 构建完成后，以生产模式执行的钩子。

```ts title="src/entry.node.ts"
import path from 'node:path';

export default {
    async postCompileProdHook(gez) {
        const render = await gez.render({
            base: '/gez',
            params: { url: '/' }
        });
        gez.writeSync(
            path.resolve(gez.getProjectPath('dist/client'), 'index.html'),
            render.html
        );
    }
} satisfies GezOptions;
```

:::tip 
你可以使用这个钩子来生成静态网站。
:::

## Gez
创建的实例。

### name <Badge text="v3.0.0" type="tip" />
- **类型：** `string`
- **描述：** 服务名称。

### root <Badge text="v3.0.0" type="tip" />
- **类型：** `string`
- **描述：** 项目根目录。

### isProd <Badge text="v3.0.0" type="tip" />
- **类型：** `boolean`
- **描述：** 是否是生产环境。

### isInstall <Badge text="v3.0.0" type="tip" />
- **类型：** `boolean`
- **描述：** 是否安装远程依赖。

### basePath <Badge text="v3.0.0" type="tip" />
- **类型：** `string`
- **描述：** 根据服务名称生成的静态资源基本路径。

### basePathPlaceholder <Badge text="v3.0.0" type="tip" />
- **类型：** `string`
- **描述：** 基本路径变量占位符。

### varName <Badge text="v3.0.0" type="tip" />
- **类型：** `string`
- **描述：** 根据服务名称生成的 JS 变量名称。

### command <Badge text="v3.0.0" type="tip" />
- **类型：** `COMMAND`
- **描述：** 当前执行的命令。

### moduleConfig <Badge text="v3.0.0" type="tip" />
- **类型：** `ParsedModuleConfig`
- **描述：** 根据传入的 [modules](#modules) 选项解析出来的对象。

::: tip
我们提供了一个 Rspack 的插件 `@gez/rspack-module-link-plugin`，`moduleConfig` 会传递为该插件的选项，除非你想要深入了解模块链接的实现，不然大多数时候你都不需要关心它。
:::

### init() <Badge text="v3.0.0" type="tip" />
- **类型：** `init(command: COMMAND): Promise<void>`
- **描述：** 初始化 Gez 实例。

### install() <Badge text="v3.0.0" type="tip" />
- **类型：** `(): Promise<boolean>`
- **描述：** 安装远程模块到本地。

### build() <Badge text="v3.0.0" type="tip" />
- **类型：** `(): Promise<boolean>`
- **描述：** 构建生产代码。

### release() <Badge text="v3.0.0" type="tip" />
- **类型：** `(): Promise<boolean>`
- **描述：** 生产代码构建完成后，可以构建版本代码，提供给其它服务使用。

### middleware() <Badge text="v3.0.0" type="tip" />
- **类型：** `Middleware`
- **描述：** 生产代码构建完成后，可以构建版本代码，提供给其它服务使用。

### render() <Badge text="v3.0.0" type="tip" />
- **类型：** `(options?: RenderContextOptions) => Promise<RenderContext>`
- **描述：** 调用 `entry.server.ts` 导出的渲染函数。
### getProjectPath() <Badge text="v3.0.0" type="tip" />
- **类型：** `getProjectPath(projectPath: ProjectPath): string`
- **描述：** 获取项目文件的绝对路径。

### destroy() <Badge text="v3.0.0" type="tip" />
- **类型：** `(): Promise<boolean>`
- **描述：** 调用 `entry.server.ts` 导出的渲染函数。

### write <Badge text="v3.0.0" type="tip" />
- **类型：** `(filepath: string, data: any): Promise<void>`
- **描述：** 异步的写入一个文件。

### writeSync <Badge text="v3.0.0" type="tip" />
- **类型：** `(filepath: string, data: any): void`
- **描述：** 同步的写入一个文件。
